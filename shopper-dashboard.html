<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workstation | My Personal Shopper</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <style>
        :root {
            --bg-body: #f0f2f5;
            --bg-sidebar: #ffffff;
            --accent: #D4AF37;
            --text-main: #333;
            --success: #2f855a;
            --danger: #e53e3e;
            --warning: #dd6b20;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Lato', sans-serif; background-color: var(--bg-body); color: var(--text-main); height: 100vh; display: flex; overflow: hidden; }

        /* --- SIDEBAR ESQUERRA: INFO CLIENT --- */
        .client-panel {
            width: 340px;
            background: var(--bg-sidebar);
            border-right: 1px solid #ddd;
            display: flex;
            flex-direction: column;
            z-index: 10;
            box-shadow: 2px 0 5px rgba(0,0,0,0.05);
        }

        .shopper-header {
            padding: 20px;
            font-size: 0.8rem;
            color: #666;
            background: #f8f8f8;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .client-selector-area {
            padding: 20px;
            border-bottom: 1px solid #eee;
        }

        select#clientSelector {
            width: 100%;
            padding: 10px;
            font-family: 'Lato', sans-serif;
            font-size: 1rem;
            border: 1px solid #ccc;
            border-radius: 4px;
            cursor: pointer;
        }

        .client-details-scroll {
            padding: 20px;
            overflow-y: auto;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .client-card {
            background: #fafafa;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }

        .client-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background-color: #ddd;
            margin: 0 auto 10px;
            background-size: cover;
            background-position: center;
            border: 2px solid #fff;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .tags { display: flex; flex-wrap: wrap; gap: 5px; justify-content: center; margin-top: 10px; }
        .tag { font-size: 0.7rem; background: #eee; padding: 3px 8px; border-radius: 12px; font-weight: bold; border: 1px solid #ddd; }
        .tag.style { background: #000; color: #fff; border-color: #000; }
        .tag.budget { background: #fffcf0; color: #b7950b; border-color: #f1c40f; }

        .info-block h4 { font-size: 0.75rem; text-transform: uppercase; border-bottom: 1px solid #eee; padding-bottom: 5px; margin-bottom: 10px; color: var(--accent); letter-spacing: 1px; }
        .info-row { display: flex; justify-content: space-between; font-size: 0.9rem; margin-bottom: 8px; align-items: center; }
        .info-row strong { font-family: 'Playfair Display', serif; font-size: 1rem; }

        /* --- ZONA CENTRAL: CAT√ÄLEG --- */
        .catalog-area {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .catalog-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .filters-container { display: flex; align-items: center; gap: 15px; flex-wrap: wrap; }
        .filters { display: flex; gap: 5px; }
        .filter-btn { padding: 8px 15px; border: 1px solid #ccc; background: #fff; border-radius: 4px; cursor: pointer; transition: 0.2s; font-size: 0.9rem; }
        .filter-btn:hover { background: #f0f0f0; }
        .filter-btn.active { background: #000; color: #fff; border-color: #000; }
        
        #brandFilter { padding: 8px 10px; border: 1px solid #ccc; border-radius: 4px; font-family: 'Lato', sans-serif; font-size: 0.9rem; cursor: pointer; min-width: 150px; }

        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            padding-bottom: 50px;
        }

        .product-card {
            background: #fff;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            transition: 0.2s;
            position: relative;
            display: flex;
            flex-direction: column;
        }
        .product-card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .product-img { height: 180px; background: #eee; background-size: cover; background-position: center; }
        .product-info { padding: 15px; flex-grow: 1; display: flex; flex-direction: column; justify-content: space-between; }
        .brand { font-size: 0.7rem; color: #888; text-transform: uppercase; font-weight: 700; }
        .name { font-weight: bold; font-size: 0.95rem; margin-bottom: 5px; line-height: 1.2;}
        .price { font-family: 'Playfair Display', serif; font-size: 1.1rem; margin-top: 5px; }

        /* CONTROL D'ESTOC VISUAL */
        .stock-badge {
            position: absolute; top: 10px; right: 10px;
            padding: 4px 8px; border-radius: 4px;
            font-size: 0.7rem; font-weight: bold;
            color: white; z-index: 2;
        }
        .stock-high { background: rgba(47, 133, 90, 0.9); } /* Verd */
        .stock-low { background: rgba(212, 175, 55, 0.9); } /* Daurat */
        .stock-out { background: rgba(229, 62, 62, 0.9); }  /* Vermell */

        .reserved-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(47, 133, 90, 0.8); /* Verd semi-transparent */
            display: flex; align-items: center; justify-content: center;
            color: white; font-weight: bold; letter-spacing: 1px;
            opacity: 0; transition: 0.3s; pointer-events: none;
        }
        /* Quan el producte est√† reservat a la caixa */
        .product-card.is-reserved .reserved-overlay { opacity: 1; }
        .product-card.out-of-stock { opacity: 0.6; }
        .product-card.out-of-stock .product-img { filter: grayscale(100%); }

        .add-btn { width: 100%; padding: 10px; background: var(--text-main); color: #fff; border: none; cursor: pointer; margin-top: 15px; border-radius: 4px; font-weight: bold; transition: 0.2s; }
        .add-btn:hover { background: var(--accent); }
        .add-btn:disabled { background: #ccc; cursor: not-allowed; }

        /* --- SIDEBAR DRETA: CAIXA --- */
        .box-panel {
            width: 320px;
            background: #fff;
            border-left: 1px solid #ddd;
            display: flex;
            flex-direction: column;
            box-shadow: -5px 0 15px rgba(0,0,0,0.05);
            z-index: 10;
        }

        .box-header { padding: 20px; background: #1a1a1a; color: #fff; text-align: center; }
        .box-count { font-family: 'Playfair Display', serif; font-size: 2.5rem; }
        .box-limit { font-size: 1rem; opacity: 0.7; }
        .box-items { flex-grow: 1; padding: 20px; overflow-y: auto; background: #fdfdfd; }
        .box-item { display: flex; gap: 10px; margin-bottom: 15px; border: 1px solid #eee; background: #fff; padding: 10px; border-radius: 6px; animation: slideIn 0.3s ease; }
        @keyframes slideIn { from { transform: translateX(20px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .box-item-img { width: 50px; height: 50px; background: #eee; border-radius: 4px; background-size: cover; }
        .box-item-details { flex-grow: 1; }
        .box-item-title { font-size: 0.85rem; font-weight: bold; }
        .remove-btn { color: #999; cursor: pointer; border:none; background:transparent; transition: 0.2s; }
        .remove-btn:hover { color: var(--danger); }

        .box-actions { padding: 20px; border-top: 1px solid #eee; background: #fff; }
        .submit-btn { width: 100%; padding: 15px; background: #ccc; color: #fff; border: none; font-size: 1rem; font-weight: bold; cursor: not-allowed; border-radius: 4px; transition: 0.3s; }
        .submit-btn.ready { background: var(--success); cursor: pointer; box-shadow: 0 4px 10px rgba(47, 133, 90, 0.3); }
        
        /* BOT√ì M√ÄGIC - NOU ESTIL */
        .btn-magic {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            border: none;
            border-radius: 4px;
            font-weight: bold;
            cursor: pointer;
            margin-bottom: 10px;
            box-shadow: 0 4px 10px rgba(118, 75, 162, 0.3);
            transition: 0.3s;
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 8px;
        }
        .btn-magic:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(118, 75, 162, 0.5);
        }
    
    /* --- RESPONSIVE MEDIA QUERIES --- */
    @media (max-width: 768px) {
        body { flex-direction: column; overflow: auto; height: auto; }
        .client-panel, .box-panel { width: 100%; height: auto; border-right: none; border-bottom: 1px solid #ddd; }
        .catalog-area { height: auto; padding-bottom: 80px; }
        .products-grid { grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .add-btn, .filter-btn { padding: 12px; font-size: 1rem; }
    }

    /* --- NOU: PANELL D'ESTAD√çSTIQUES --- */
    .stats-panel { display: flex; gap: 20px; margin-bottom: 30px; flex-wrap: wrap; }
    .stat-card {
        background: #fff; padding: 20px; border-radius: 8px; flex: 1; min-width: 200px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.05); border-left: 4px solid #ddd;
        display: flex; flex-direction: column; justify-content: center;
    }
    .stat-card.sales { border-left-color: #2f855a; }
    .stat-card.pending { border-left-color: #d4af37; }
    .stat-card.orders { border-left-color: #3182ce; }
    .stat-title { font-size: 0.75rem; text-transform: uppercase; color: #888; font-weight: bold; letter-spacing: 1px; margin-bottom: 5px; }
    .stat-value { font-size: 1.8rem; font-weight: bold; color: #1a1a1a; font-family: 'Playfair Display', serif; }
    .stat-subtext { font-size: 0.8rem; color: #aaa; margin-top: 5px; }

    /* ESTILS PER A LES VALORACIONS */
    .feedback-card { border-left: 4px solid #D4AF37 !important; cursor: pointer; transition: transform 0.2s; }
    .feedback-card:hover { transform: translateY(-3px); }
    .feedback-list { max-height: 400px; overflow-y: auto; }
    .feedback-item { background: #f9f9f9; padding: 15px; border-bottom: 1px solid #eee; margin-bottom: 10px; border-radius: 4px; }
    .stars { color: #D4AF37; font-size: 1.2rem; }
    .feedback-date { float: right; font-size: 0.8rem; color: #999; }
    .feedback-text { margin-top: 5px; font-style: italic; color: #555; }

    /* MODAL */
    .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); backdrop-filter: blur(2px); }
    .modal-content { background-color: #fff; margin: 5% auto; padding: 30px; border: 1px solid #888; width: 90%; max-width: 600px; border-radius: 8px; position: relative; box-shadow: 0 20px 50px rgba(0,0,0,0.3); max-height: 90vh; overflow-y: auto; }
    .close { position: absolute; top: 15px; right: 20px; color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; }

    </style>
</head>
<body>

    <aside class="client-panel">
        <div class="shopper-header">
            <span class="material-icons" style="font-size:16px;">work</span> Workstation: <strong>Juli Alafia</strong>
        </div>

        <div class="client-selector-area">
            <label style="font-size: 0.7rem; font-weight:bold; color:#888; display:block; margin-bottom:5px;">CLIENT ACTUAL:</label>
            <select id="clientSelector" onchange="changeClient()">
                </select>
        </div>
        
        <div class="client-details-scroll" id="clientDetails">
            </div>
    </aside>

    <section class="catalog-area">
        <div class="stats-panel">
        <div class="stat-card sales">
            <div class="stat-title">Facturaci√≥ Total</div>
            <div class="stat-value" id="statTotalSales">0‚Ç¨</div>
            <div class="stat-subtext">Vendes confirmades</div>
        </div>
        <div class="stat-card pending">
            <div class="stat-title">Per Preparar</div>
            <div class="stat-value" id="statPendingCount">0</div>
            <div class="stat-subtext">Clients esperant</div>
        </div>
        <div class="stat-card orders">
            <div class="stat-title">Caixes Enviades</div>
            <div class="stat-value" id="statCompletedCount">0</div>
            <div class="stat-subtext">Total hist√≤ric</div>
        </div>
        <div class="stat-card feedback-card" onclick="openFeedbackModal()">
            <div class="stat-title">Satisfacci√≥ (NPS)</div>
            <div class="stat-value" id="statAvgRating">0.0 ‚òÖ</div>
            <div class="stat-subtext">Clica per veure opinions</div>
        </div>
    </div>
        <div class="catalog-header">
            <h2>Cat√†leg</h2>
            
            <div class="filters-container">
                <div class="filters">
                    <button class="filter-btn active" onclick="setCategoryFilter('all', this)">Tot</button>
                    <button class="filter-btn" onclick="setCategoryFilter('top', this)">Superior</button>
                    <button class="filter-btn" onclick="setCategoryFilter('bottom', this)">Inferior</button>
                    <button class="filter-btn" onclick="setCategoryFilter('shoes', this)">Sabates</button>
                    <button class="filter-btn" onclick="setCategoryFilter('acc', this)">Acc.</button>
                </div>

                <select id="brandFilter" onchange="setBrandFilter(this.value)">
                    <option value="all">Totes les Marques</option>
                </select>
            </div>
        </div>

        <div class="products-grid" id="productGrid"></div>
    </section>

    <aside class="box-panel">
        <div class="box-header">
            <p id="boxHeaderTitle">CAIXA DE LA JULIETA</p>
            <div>
                <span class="box-count" id="boxCount">0</span>
                <span class="box-limit">/ 5 peces</span>
            </div>
        </div>

        <div class="box-items" id="boxItemsContainer">
            <p style="text-align:center; color:#999; margin-top:50px;">La caixa est√† buida.</p>
        </div>

        <div class="box-actions">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px; font-weight:bold;">
                <span>Total Estimat:</span>
                <span id="boxTotal">0‚Ç¨</span>
            </div>
            
            <button class="btn-magic" onclick="autoFillBoxMagic()">
                <span class="material-icons">auto_awesome</span> M√ÄGIA IA (AUTO)
            </button>

            <button class="submit-btn" id="submitBtn" onclick="finalitzarComanda()">ENVIAR CAIXA</button>
        </div>
    </aside>

    <div id="feedbackModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeFeedbackModal()">&times;</span>
        <h2>Opinions dels Clients</h2>
        <p style="margin-bottom:20px; color:#666;">Aquestes s√≥n les darreres valoracions rebudes:</p>
        <div id="feedbackListContainer" class="feedback-list">
            <p>Carregant...</p>
        </div>
    </div>
    </div>

   <script type="module">
    import { db, ref, onValue, update } from './firebase.js';

    // --- CONFIGURACI√ì INICIAL ---
    const mockClients = [
        { id: 0, name: "Julieta Serrano", since: "Oct 2025", img: "https://images.unsplash.com/photo-1438761681033-6461ffad8d80?ixlib=rb-1.2.1&auto=format&fit=crop&w=300&q=80", tags: ["Mock"], sizes: { top: "M", bottom: "38", shoes: "39", fit: "Regular" }, note: "Exemple est√†tic.", alert: "No es pot editar." }
    ];
    let clients = [...mockClients];
    let currentRealUserId = null;
    let currentOrderId = null;
    let allFeedbacks = []; // Per al modal de valoracions

    // --- GESTI√ì D'ESTOC (MODIFICAT) ---
    // Ara 'stock' √©s un n√∫mero real, no un string
    const products = [
        { id: 1, name: "Camisa Flors", brand: "Zara", price: 45, category: "top", stock: 8, img: "https://images.unsplash.com/photo-1596755094514-f87e34085b2c?w=400" },
        { id: 2, name: "Texans Turquesa", brand: "Levis", price: 60, category: "bottom", stock: 5, img: "https://encrypted-tbn0.gstatic.com/shopping?q=tbn:ANd9GcR_ts3qG5BTsia1hpbd9830ZXs1GMTBj-vrGQnCQAckZhIMbCyaz7ERjy3qp9XvtXm78HNleVkSAq4XH7o_beFGOcFfWQ1qXyUfXw9RKVr0NL6oZDYrL3Sd8nZ9XS35H56G-alOZQNR9A&usqp=CAc" },
        { id: 3, name: "Motxilla Storm", brand: "Storm", price: 25, category: "acc", stock: 12, img: "https://images.unsplash.com/photo-1553062407-98eeb64c6a62?w=400" },
        { id: 4, name: "Jaqueta Cuir", brand: "Mango", price: 120, category: "top", stock: 2, img: "https://encrypted-tbn1.gstatic.com/shopping?q=tbn:ANd9GcTijlzsQQPw9PBJRGW0Zaj_nVboq3GwfJGL4s_82VlDzCqELT3EagIOumoHIDyZ9c71INxuu1DkLOisuVHLu02JuvvMjWx9GJ8mbatkYAj-nt53yaQoPMGWIwEQRaTAHq3XhP1fKm0&usqp=CAc" }, // Low stock
        { id: 5, name: "Sand√†lies", brand: "CoolWalk", price: 30, category: "shoes", stock: 6, img: "https://encrypted-tbn0.gstatic.com/shopping?q=tbn:ANd9GcR2u3ffKM0rZWFqJbJGxuWb86bWTr61M-7SwYqz8r5VV2DrDFMAxOzHKPkH_BAzWuKb_3YyZ1rkj6MGSy1EBbB-pLxgZhPYKtCXojHYOI86DpfJWqLq1lU2582_OVyhhYcbcl6cqLlF_Q&usqp=CAc0" },
        { id: 6, name: "Cintur√≥ Snake", brand: "Storm", price: 15, category: "acc", stock: 0, img: "https://images.unsplash.com/photo-1624222247344-550fb60583dc?w=400" }, // Out
        { id: 7, name: "Vestit Estiu", brand: "H&M", price: 35, category: "top", stock: 4, img: "https://images.unsplash.com/photo-1572804013309-59a88b7e92f1?w=400" },
        { id: 8, name: "Barret Explorer", brand: "Storm", price: 20, category: "acc", stock: 10, img: "https://images.unsplash.com/photo-1514327605112-b887c0e61c0a?w=400" },
        { id: 9, name: "Camisa Oxford", brand: "Ralph", price: 85, category: "top", stock: 3, img: "https://images.unsplash.com/photo-1598033129183-c4f50c736f10?w=400" },
        { id: 10, name: "Pantalons Chino", brand: "Dockers", price: 55, category: "bottom", stock: 7, img: "https://images.unsplash.com/photo-1624378439575-d8705ad7ae80?w=400" },
        { id: 11, name: "Sneakers Urban", brand: "Nike", price: 95, category: "shoes", stock: 5, img: "https://images.unsplash.com/photo-1549298916-b41d501d3772?w=400" },
        { id: 12, name: "Ulleres Sol", brand: "RayBan", price: 110, category: "acc", stock: 1, img: "https://images.unsplash.com/photo-1572635196237-14b3f281503f?w=400" }, // √öltima unitat
        { id: 13, name: "Blazer Blau", brand: "Massimo", price: 150, category: "top", stock: 3, img: "https://images.unsplash.com/photo-1591047139829-d91aecb6caea?w=400" },
        { id: 14, name: "Faldilla Midi", brand: "Zara", price: 40, category: "bottom", stock: 6, img: "https://images.unsplash.com/photo-1583496661160-fb5886a0aaaa?w=400" },
        { id: 15, name: "Botes Pell", brand: "Timber", price: 130, category: "shoes", stock: 0, img: "https://encrypted-tbn2.gstatic.com/shopping?q=tbn:ANd9GcQC2HJfLkyW9rVLfD5-WDgIv0OVozCgq30KyjeocJVCi68NINcPkYyb9yeRhbipGRTx-W3PDOBS9apr2XNof1rGbWIMzozMcMALeB2N2EhS-y--FCAVwUyPW8p91gh7AL3bobY0gsQhIA&usqp=CAc" },
        { id: 16, name: "Mocador Seda", brand: "Gucci", price: 200, category: "acc", stock: 2, img: "https://images.unsplash.com/photo-1584030373081-f37b7bb4fa8e?w=400" }
    ];

    let box = [];
    let currentCategoryFilter = 'all';
    let currentBrandFilter = 'all';

    // Globals per al HTML (IMPORTANT perque funcioni els onlicks)
    window.changeClient = changeClient;
    window.setCategoryFilter = setCategoryFilter;
    window.setBrandFilter = setBrandFilter;
    window.addToBox = addToBox;
    window.removeFromBox = removeFromBox;
    window.finalitzarComanda = finalitzarComanda;
    window.openFeedbackModal = openFeedbackModal;
    window.closeFeedbackModal = closeFeedbackModal;
    window.autoFillBoxMagic = autoFillBoxMagic;

    // --- LISTENER PRINCIPAL (CLIENTS) ---
    const usersRef = ref(db, 'users');
    onValue(usersRef, (snapshot) => {
        const data = snapshot.val();
        clients = [...mockClients];

        let totalFacturacio = 0;
        let totalPendents = 0;
        let totalFinalitzades = 0;

        if (data) {
            Object.keys(data).forEach((key) => {
                const userReal = data[key];
                const estil = userReal.estil || {};
                let hasPendingOrder = false;
                
                if (userReal.comandes) {
                    const comandes = Object.values(userReal.comandes);
                    comandes.forEach(order => {
                        if (order.estat === 'pendent_preparacio') {
                            hasPendingOrder = true;
                            totalPendents++;
                        }
                        if (order.estat === 'finalitzada' && order.items) {
                            totalFinalitzades++;
                            let itemsQuedats = order.items.filter(i => i.kept === true);
                            let subtotal = itemsQuedats.reduce((sum, item) => sum + item.price, 0);
                            
                            if (itemsQuedats.length === 5) totalFacturacio += (subtotal * 0.75);
                            else if (itemsQuedats.length > 0) totalFacturacio += subtotal;
                            else totalFacturacio += 10;
                        }
                    });
                }

                const userTags = [];
                if (hasPendingOrder) userTags.push("üî¥ NOVA COMANDA");
                if (estil.estilVisual) userTags.push(estil.estilVisual);
                
                clients.push({
                    id: key, 
                    name: (userReal.nom || "") + " " + (userReal.cognoms || ""),
                    since: userReal.dataRegistre ? new Date(userReal.dataRegistre).toLocaleDateString() : "Avui",
                    img: "https://ui-avatars.com/api/?name=" + (userReal.nom || "U") + "+" + (userReal.cognoms || "ser") + "&background=random",
                    tags: userTags,
                    sizes: { top: estil.talles?.top || "-", bottom: estil.talles?.bottom || "-", shoes: estil.talles?.sabates || "-", fit: estil.ajust || "Regular" }, 
                    note: estil.notes || "Sense notes.",
                    alert: hasPendingOrder ? "Esperant selecci√≥ de roba." : "Tot al dia.",
                    comandes: userReal.comandes
                });
            });
        }

        document.getElementById('statTotalSales').innerText = totalFacturacio.toFixed(2) + "‚Ç¨";
        document.getElementById('statPendingCount').innerText = totalPendents;
        document.getElementById('statCompletedCount').innerText = totalFinalitzades;

        initClientSelector();
    });

    // --- LISTENER VALORACIONS ---
    onValue(ref(db, 'valoracions'), (snapshot) => {
        const data = snapshot.val();
        allFeedbacks = [];
        let totalStars = 0;
        let count = 0;
        if (data) {
            Object.values(data).forEach(review => {
                allFeedbacks.push(review);
                totalStars += review.rating;
                count++;
            });
            const avg = count > 0 ? (totalStars / count).toFixed(1) : "0.0";
            const ratingEl = document.getElementById('statAvgRating');
            if(ratingEl) ratingEl.innerText = avg + " ‚òÖ";
        }
    });

    // --- LOGICA UI ---
    function initClientSelector() {
        const selector = document.getElementById('clientSelector');
        const currentValue = selector.value;
        selector.innerHTML = '';
        clients.forEach(c => {
            const option = document.createElement('option');
            option.value = c.id;
            const hasOrder = c.tags && c.tags.includes("üî¥ NOVA COMANDA");
            option.innerText = (hasOrder ? "üî¥ " : "") + c.name;
            selector.appendChild(option);
        });
        
        if (!currentValue || !clients.find(c => c.id == currentValue)) {
            const priorityClient = clients.find(c => c.tags && c.tags.includes("üî¥ NOVA COMANDA"));
            if(priorityClient) { selector.value = priorityClient.id; changeClient(); } 
            else if (clients.length > 0) { selector.value = clients[0].id; changeClient(); }
        } else {
            selector.value = currentValue;
        }
    }

    function changeClient() {
        const selector = document.getElementById('clientSelector');
        const client = clients.find(c => c.id == selector.value);
        if (!client) return;

        currentRealUserId = client.id;
        currentOrderId = null; 
        let statusText = "No hi ha comandes pendents";
        const btn = document.getElementById('submitBtn');
        
        if (client.comandes) {
            const orderEntry = Object.entries(client.comandes).find(([key, val]) => val.estat === 'pendent_preparacio');
            if (orderEntry) {
                currentOrderId = orderEntry[0]; 
                statusText = "üü¢ Preparant Comanda Activa";
                btn.style.display = 'block';
            } else { statusText = "El client no ha demanat caixa."; }
        }

        document.getElementById('clientDetails').innerHTML = `
            <div class="client-card">
                <div class="client-avatar" style="background-image: url('${client.img}')"></div>
                <h3>${client.name}</h3>
                <div style="margin:10px 0; font-weight:bold; color:#d4af37;">${statusText}</div>
                <div class="tags">${client.tags.map(t => `<span class="tag">${t}</span>`).join('')}</div>
            </div>
            <div class="info-block">
                <h4>Talles i Prefer√®ncies</h4>
                <div class="info-row"><span>Superior:</span> <strong>${client.sizes.top}</strong></div>
                <div class="info-row"><span>Inferior:</span> <strong>${client.sizes.bottom}</strong></div>
                <div class="info-row"><span>Sabates:</span> <strong>${client.sizes.shoes}</strong></div>
                <div class="info-row" style="margin-top:5px; padding-top:5px; border-top:1px dashed #eee;"><span>Fit:</span> <strong style="color:var(--accent);">${client.sizes.fit}</strong></div>
            </div>
            <div class="info-block"><h4>Notes</h4><p style="font-size: 0.85rem; color: #555; font-style: italic;">"${client.note}"</p></div>
        `;

        box = [];
        document.getElementById('boxHeaderTitle').innerText = `CAIXA DE ${client.name.split(' ')[0].toUpperCase()}`;
        updateBoxUI();
        renderCatalog();
    }

    // --- ENVIAMENT I GESTI√ì D'ESTOC REIAL ---
    function finalitzarComanda() {
        if (!currentRealUserId || !currentOrderId) { alert("No hi ha comanda activa."); return; }
        if (box.length !== 5) { alert("Selecciona 5 peces."); return; }

        if(confirm("Confirmes l'enviament? Es descomptar√† l'estoc.")) {
            // 1. Descomptem estoc de la variable local (Simulaci√≥)
            box.forEach(item => {
                const productInArr = products.find(p => p.id === item.id);
                if(productInArr && productInArr.stock > 0) productInArr.stock--; 
            });

            // 2. Enviem a Firebase
            const updates = {};
            const basePath = `/users/${currentRealUserId}/comandes/${currentOrderId}`;
            updates[basePath + '/estat'] = 'enviada';
            updates[basePath + '/items'] = box;
            updates[basePath + '/dataEnviament'] = new Date().toISOString();

            update(ref(db), updates).then(() => {
                alert("Caixa enviada i estoc actualitzat!");
                box = [];
                updateBoxUI();
                renderCatalog(); // Refresquem per veure el nou estoc
            });
        }
    }

    // --- UI CAT√ÄLEG AMB CONTROL D'ESTOC ---
    function initBrandFilter() {
        const brandSelect = document.getElementById('brandFilter');
        const brands = [...new Set(products.map(p => p.brand))].sort();
        brands.forEach(brand => {
            const opt = document.createElement('option');
            opt.value = brand; opt.innerText = brand;
            brandSelect.appendChild(opt);
        });
    }
    function setCategoryFilter(c, b) { currentCategoryFilter = c; document.querySelectorAll('.filter-btn').forEach(x => x.classList.remove('active')); b.classList.add('active'); renderCatalog(); }
    function setBrandFilter(b) { currentBrandFilter = b; renderCatalog(); }
    
    function renderCatalog() {
        const grid = document.getElementById('productGrid');
        grid.innerHTML = '';
        const filtered = products.filter(p => (currentCategoryFilter === 'all' || p.category === currentCategoryFilter) && (currentBrandFilter === 'all' || p.brand === currentBrandFilter));
        
        filtered.forEach(p => {
            // Mirem si est√† a la caixa actual
            const isInBox = box.find(i => i.id === p.id);
            
            // C√†lcul d'estoc disponible visual
            // Si est√† a la caixa, "restem" 1 visualment
            const currentStock = p.stock; 
            
            let badgeClass = 'stock-high';
            let badgeText = `${currentStock} u.`;
            let btnText = 'Afegir';
            let btnDisabled = false;
            let cardClass = '';

            if (currentStock === 0) {
                badgeClass = 'stock-out'; badgeText = 'ESGOTAT';
                btnText = 'No Stock'; btnDisabled = true;
                cardClass = 'out-of-stock';
            } else if (currentStock <= 3) {
                badgeClass = 'stock-low'; badgeText = `√öltims ${currentStock}!`;
            }

            if (isInBox) {
                btnText = 'Reservat ‚úì';
                cardClass += ' is-reserved'; // Activa l'overlay CSS
            }

            const card = document.createElement('div');
            card.className = `product-card ${cardClass}`;
            card.innerHTML = `
                <div class="stock-badge ${badgeClass}">${badgeText}</div>
                <div class="reserved-overlay">RESERVAT A CAIXA</div>
                <div class="product-img" style="background-image: url('${p.img}')"></div>
                <div class="product-info">
                    <div><div class="brand">${p.brand}</div><div class="name">${p.name}</div><div class="price">${p.price}‚Ç¨</div></div>
                    <button class="add-btn" onclick="addToBox(${p.id})" ${btnDisabled || isInBox ? 'disabled' : ''} style="${isInBox ? 'background:#2f855a' : ''}">${btnText}</button>
                </div>`;
            grid.appendChild(card);
        });
    }

    function addToBox(id) { 
        if (box.length >= 5 || box.find(i => i.id === id)) return; 
        const prod = products.find(p => p.id === id);
        if(prod.stock > 0) {
            // Quan afegim manualment, netegem qualsevol nota autom√†tica antiga
            prod.stylistNote = null;
            box.push(prod); 
            updateBoxUI(); 
            renderCatalog(); 
        }
    }
    
    function removeFromBox(idx) { 
        box.splice(idx, 1); 
        updateBoxUI(); 
        renderCatalog(); 
    }

    // --- FUNCI√ì M√ÄGIA IA (AUTO) ---
    function autoFillBoxMagic() {
        if (!currentOrderId) { alert("Selecciona primer un client amb comanda activa."); return; }
        
        // 1. Buidem la caixa actual
        box = [];
        
        // 2. Filtrem productes amb estoc
        const availableProducts = products.filter(p => p.stock > 0);
        
        // 3. Barregem (Shuffle)
        const shuffled = availableProducts.sort(() => 0.5 - Math.random());
        
        // 4. Agafem els 5 primers
        const selected = shuffled.slice(0, 5);
        
        // 5. Afegim justificaci√≥ simulada
        const reasons = [
            "Combina amb el fit que vas demanar.",
            "Tend√®ncia clau aquesta temporada.",
            "Un b√†sic que no et pot faltar.",
            "Color ideal per al teu to de pell.",
            "Va perfecte amb la teva √∫ltima compra."
        ];

        selected.forEach(p => {
            p.stylistNote = reasons[Math.floor(Math.random() * reasons.length)];
            box.push(p);
        });

        updateBoxUI();
        renderCatalog();
        alert("‚ú® La IA ha generat una proposta basada en l'estoc i el perfil.");
    }

    function updateBoxUI() {
        const container = document.getElementById('boxItemsContainer');
        const btn = document.getElementById('submitBtn');
        document.getElementById('boxCount').innerText = box.length;
        
        let total = 0;
        container.innerHTML = '';
        box.forEach((item, idx) => {
            total += item.price;
            
            // Si hi ha una nota d'estilista (IA), la mostrem en lila
            const noteHtml = item.stylistNote ? `<div style="font-size:0.7rem; color:#8e44ad; font-style:italic; margin-top:4px;">‚ú® ${item.stylistNote}</div>` : '';

            container.innerHTML += `
            <div class="box-item">
                <div class="box-item-img" style="background-image:url('${item.img}')"></div>
                <div class="box-item-details">
                    <div class="box-item-title">${item.name}</div>
                    <div>${item.price}‚Ç¨</div>
                    ${noteHtml}
                </div>
                <button class="remove-btn" onclick="removeFromBox(${idx})">üóëÔ∏è</button>
            </div>`;
        });
        document.getElementById('boxTotal').innerText = total + '‚Ç¨';
        
        if(box.length === 5 && currentOrderId) {
            btn.classList.add('ready'); btn.disabled = false; btn.innerText = "ENVIAR CAIXA";
        } else {
            btn.classList.remove('ready'); btn.disabled = true; btn.innerText = currentOrderId ? `Falten ${5-box.length} peces` : "Selecciona client actiu";
        }
    }

    // Modal funcions
    function openFeedbackModal() {
        const modal = document.getElementById('feedbackModal');
        const container = document.getElementById('feedbackListContainer');
        modal.style.display = "block";
        container.innerHTML = "";
        if (allFeedbacks.length === 0) { container.innerHTML = "<p>Encara no hi ha valoracions.</p>"; return; }
        allFeedbacks.sort((a, b) => new Date(b.date) - new Date(a.date));
        allFeedbacks.forEach(review => {
            let starsHtml = "";
            for(let i=0; i<5; i++) starsHtml += i < review.rating ? "‚òÖ" : "‚òÜ";
            container.innerHTML += `<div class="feedback-item"><div><span class="stars">${starsHtml}</span><span class="feedback-date">${new Date(review.date).toLocaleDateString()}</span></div><div style="font-weight:bold; font-size:0.9rem; margin-top:5px;">Client An√≤nim</div><div class="feedback-text">"${review.comment || ''}"</div></div>`;
        });
    }
    function closeFeedbackModal() { document.getElementById('feedbackModal').style.display = "none"; }
    window.onclick = function(event) { if (event.target == document.getElementById('feedbackModal')) closeFeedbackModal(); }

    initBrandFilter();
    initClientSelector();
    renderCatalog();
</script>
</body>
</html>