<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>El meu espai | My Personal Shopper</title>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        /* --- ESTILS BASE --- */
        :root { --color-bg: #f4f4f4; --color-text: #1a1a1a; --accent: #D4AF37; --font-title: 'Playfair Display', serif; --font-body: 'Lato', sans-serif; }
        body { background: var(--color-bg); font-family: var(--font-body); color: var(--color-text); margin: 0; }
        header { background: #fff; padding: 15px 5%; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #ddd; }
        .logo { font-family: var(--font-title); font-weight: 700; font-size: 1.2rem; }
        .user-menu { display: flex; gap: 20px; font-size: 0.9rem; align-items: center; }
        .user-menu a { text-decoration: none; color: #666; }
        .avatar-mini { width: 35px; height: 35px; background: #eee; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; }

        main { max-width: 900px; margin: 40px auto; padding: 20px; padding-bottom: 100px; }
        h1 { font-family: var(--font-title); font-size: 2.5rem; text-align: center; margin-bottom: 10px; }
        
        /* HERO CARD */
        .hero-card { background: #fff; padding: 60px 40px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.05); border-top: 4px solid var(--accent); margin-bottom: 50px; position: relative; }
        .hero-title { font-size: 1.5rem; margin-bottom: 20px; text-transform: uppercase; letter-spacing: 2px; }
        .btn-order { background: #000; color: #fff; padding: 20px 50px; font-size: 1.2rem; border: none; cursor: pointer; text-transform: uppercase; letter-spacing: 1px; transition: 0.3s; }
        .btn-order:hover { background: var(--accent); }
        
        /* ESTATS */
        .status-container { display: none; }
        .status-icon { font-size: 4rem; color: var(--accent); margin-bottom: 20px; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }

        /* REVISI√ì ITEMS */
        .review-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-top: 30px; text-align: left; }
        .review-item { border: 1px solid #eee; padding: 10px; border-radius: 4px; background: #fff; position: relative; }
        .review-img { height: 140px; background-size: cover; background-position: center; margin-bottom: 10px; border-radius: 2px; }
        .toggle-btn { width: 100%; padding: 10px; margin-top: 10px; cursor: pointer; border: 1px solid #ddd; background: #fff; transition: 0.2s; }
        .toggle-btn.keep { background: #2f855a; color: white; border-color: #2f855a; }
        .toggle-btn::after { content: "Retornar"; }
        .toggle-btn.keep::after { content: "Quedar-m'ho"; }

        /* ZONA DE PREU DETALLAT */
        #reviewTotalArea { background: #f9f9f9; padding: 20px; border-radius: 8px; text-align: right; margin-bottom: 20px; font-family: var(--font-body); }
        .price-row { display: flex; justify-content: flex-end; gap: 20px; margin-bottom: 5px; font-size: 0.95rem; color: #555; }
        .price-final { border-top: 1px solid #ddd; margin-top: 10px; padding-top: 10px; font-size: 1.3rem; font-weight: bold; color: #000; display: flex; justify-content: flex-end; gap: 20px; }
        .discount-text { color: #2f855a; font-weight: bold; }
        .alert-text { color: #e53e3e; font-size: 0.85rem; margin-top: 5px; }

        /* STYLE MATCH */
        .match-badge { background: linear-gradient(90deg, #D4AF37 0%, #f1c40f 100%); color: #fff; padding: 3px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; display: inline-block; margin-bottom: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .match-reason { font-size: 0.75rem; color: #555; background: #f9f9f9; padding: 5px; border-radius: 4px; margin-top: 5px; border-left: 2px solid #D4AF37; font-style: italic; }
        .compatibility-bar { height: 4px; background: #eee; border-radius: 2px; margin-top: 5px; overflow: hidden; }
        .compatibility-fill { height: 100%; background: #2f855a; }

        /* HISTORIAL */
        .history-section { margin-top: 50px; }
        .history-list { list-style: none; padding: 0; }
        .history-item { background: #fff; padding: 20px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; border-left: 4px solid #ccc; transition: 0.2s; }
        .history-item:hover { transform: translateX(5px); }
        .history-item.done { border-left-color: var(--accent); }
        .details-link { color: var(--accent); font-weight: bold; cursor: pointer; text-decoration: underline; }

        /* MODAL GENERAL */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); backdrop-filter: blur(2px); }
        .modal-content { background-color: #fff; margin: 5% auto; padding: 30px; border: 1px solid #888; width: 90%; max-width: 600px; border-radius: 8px; position: relative; box-shadow: 0 20px 50px rgba(0,0,0,0.3); max-height: 90vh; overflow-y: auto; }
        .close-modal { position: absolute; top: 15px; right: 20px; color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; }
        .modal-items-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 15px; margin-top: 20px; }
        .modal-item-card { text-align: center; border: 1px solid #eee; padding: 10px; border-radius: 4px; }
        .modal-item-img { width: 100%; height: 100px; background-size: cover; background-position: center; margin-bottom: 5px; }

        /* --- TIQUET DIGITAL --- */
        .receipt-content { max-width: 450px; background: #fffcf9; border: 1px solid #eee; box-shadow: 0 5px 25px rgba(0,0,0,0.1); }
        .receipt-header { text-align: center; margin-bottom: 20px; padding-bottom: 20px; border-bottom: 2px dashed #ddd; }
        .receipt-logo { font-family: 'Playfair Display', serif; font-weight: 700; color: #D4AF37; font-size: 1.8rem; letter-spacing: 1px; }
        .receipt-subtitle { font-size: 0.8rem; color: #888; text-transform: uppercase; margin-top: 5px; }
        .receipt-details { margin-bottom: 20px; font-size: 0.9rem; }
        .receipt-row { display: flex; justify-content: space-between; margin-bottom: 8px; }
        .receipt-row.total { font-size: 1.2rem; font-weight: bold; border-top: 2px solid #000; padding-top: 15px; margin-top: 15px; }
        .receipt-discount { color: #2f855a; }
        .receipt-footer { text-align: center; margin-top: 30px; font-size: 0.8rem; color: #888; }

        /* --- VALORACI√ì (FEEDBACK) --- */
        .rating-content { text-align: center; max-width: 400px; }
        .stylist-avatar-large { width: 80px; height: 80px; border-radius: 50%; background: #eee url('https://images.unsplash.com/photo-1438761681033-6461ffad8d80?ixlib=rb-1.2.1&auto=format&fit=crop&w=300&q=80') center/cover; margin: 0 auto 15px; border: 3px solid #fff; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .star-rating { display: flex; justify-content: center; gap: 10px; margin: 20px 0; }
        .star-btn { font-size: 2.5rem; color: #ddd; cursor: pointer; transition: 0.2s; }
        .star-btn:hover, .star-btn.active { color: #D4AF37; transform: scale(1.1); }
        textarea.feedback-input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: var(--font-body); resize: none; margin-bottom: 20px; }

        /* RESPONSIVE */
        @media (max-width: 768px) {
            .review-grid { grid-template-columns: repeat(2, 1fr); }
            #chatWindow { width: 90%; right: 5%; bottom: 90px; }
        }
    </style>
</head>
<body>

    <header>
        <div class="logo">MY PERSONAL SHOPPER</div>
        <nav class="user-menu">
            <a href="perfil-estil.html">El meu Perfil</a>
            <a href="index.html">Sortir</a>
            <div class="avatar-mini"></div>
        </nav>
    </header>

    <main>
        <h1 id="welcomeTitle">Carregant...</h1>
        <p style="text-align: center; color: #666; margin-bottom: 40px;">Gestiona els teus enc√†rrecs aqu√≠.</p>

        <div class="hero-card" id="heroCard">
            <div id="stateRequest" class="status-container" style="display:block;">
                <div class="hero-title">Vull una nova selecci√≥</div>
                <button class="btn-order" onclick="processOrder()">Demanar Caixa (10‚Ç¨)</button>
                <p style="margin-top:15px; font-size:0.9rem; color:#888;">Es carregar√† el cost de servei.</p>
            </div>
            <div id="statePending" class="status-container">
                <div class="status-icon"><span class="material-icons" style="font-size:4rem">hourglass_empty</span></div>
                <div class="hero-title">La Marta est√† preparant la teva caixa</div>
                <p>T'avisarem quan estigui llesta.</p>
            </div>
            <div id="stateShipping" class="status-container">
                <div class="status-icon"><span class="material-icons" style="font-size:4rem">local_shipping</span></div>
                <div class="hero-title">La caixa est√† en cam√≠!</div>
                <p>Arribada estimada en: <span id="timer" style="font-weight:bold; font-size:1.2rem;">15</span> segons.</p>
            </div>
            <div id="stateReview" class="status-container">
                <div class="hero-title">La caixa ha arribat!</div>
                <p>Qu√® et vols quedar? Marca les peces que t'agradin.</p>
                <div id="reviewItemsGrid" class="review-grid"></div>
                
                <div style="margin-top: 30px; border-top: 1px solid #eee; padding-top: 20px;">
                    <div id="reviewTotalArea"></div>
                    <button class="btn-order" style="padding: 15px 30px; font-size: 1rem;" onclick="finalizeReview()">Finalitzar i Pagar</button>
                </div>
            </div>
        </div>

        <section class="history-section">
            <h2 style="font-size:1.2rem; text-transform:uppercase; border-bottom:1px solid #ccc; padding-bottom:10px; margin-bottom:20px;">Darreres Comandes</h2>
            <ul class="history-list" id="historyList"></ul>
        </section>
    </main>

    <div id="detailsModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal()">&times;</span>
            <h2 style="font-family: 'Playfair Display'; margin-bottom: 10px;">Detalls de la Comanda</h2>
            <p id="modalDate" style="color:#666; border-bottom:1px solid #eee; padding-bottom:10px;">-</p>
            <div id="modalItemsContainer" class="modal-items-grid"></div>
            <div id="modalEmptyMsg" style="text-align:center; padding:20px; color:#999; display:none;">No hi ha detalls disponibles.</div>
        </div>
    </div>

    <div id="receiptModal" class="modal" style="z-index: 1100;">
        <div class="modal-content receipt-content">
            <div class="receipt-header">
                <div class="receipt-logo">MY PERSONAL SHOPPER</div>
                <div class="receipt-subtitle">Resum de Compra</div>
            </div>
            <div style="margin-bottom: 20px;">Data: <strong id="receiptDate"></strong></div>
            <div id="receiptBody" class="receipt-details"></div>
            <button class="btn-order" style="width:100%; padding: 15px; font-size:1rem;" onclick="closeReceiptAndFinish()">Acceptar i Tancar</button>
            <div class="receipt-footer">Gr√†cies per confiar en nosaltres.<br>Rebr√†s un email amb aquest detall.</div>
        </div>
    </div>

    <div id="ratingModal" class="modal" style="z-index: 1200;">
        <div class="modal-content rating-content">
            <h2 style="font-family: 'Playfair Display'; margin-bottom: 10px;">Valora la teva experi√®ncia</h2>
            <p style="color:#666; font-size:0.9rem; margin-bottom:20px;">Qu√® t'ha semblat la selecci√≥ de la <strong>Marta</strong>?</p>
            <div class="stylist-avatar-large"></div>
            <div class="star-rating" id="starContainer">
                <span class="material-icons star-btn" onclick="rateStar(1)">star</span>
                <span class="material-icons star-btn" onclick="rateStar(2)">star</span>
                <span class="material-icons star-btn" onclick="rateStar(3)">star</span>
                <span class="material-icons star-btn" onclick="rateStar(4)">star</span>
                <span class="material-icons star-btn" onclick="rateStar(5)">star</span>
            </div>
            <textarea id="feedbackText" class="feedback-input" rows="3" placeholder="Deixa un comentari (opcional)..."></textarea>
            <button class="btn-order" style="width:100%; padding: 12px; font-size:1rem;" onclick="submitFeedback()">Enviar Valoraci√≥</button>
            <div style="margin-top:10px; font-size:0.8rem; cursor:pointer; color:#999;" onclick="skipFeedback()">Saltar aquest pas</div>
        </div>
    </div>

    <div id="chatWidget" style="position: fixed; bottom: 20px; right: 20px; z-index: 9999;">
        <button onclick="toggleChat()" style="width: 60px; height: 60px; border-radius: 50%; background: #000; color: #fff; border: none; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.2); display: flex; align-items: center; justify-content: center;">
            <span class="material-icons" style="font-size: 28px;">chat</span>
        </button>
        <div id="chatWindow" style="display: none; position: absolute; bottom: 80px; right: 0; width: 300px; height: 400px; background: #fff; border-radius: 10px; box-shadow: 0 5px 20px rgba(0,0,0,0.2); flex-direction: column; overflow: hidden; border: 1px solid #ddd;">
            <div style="background: #000; color: #fff; padding: 15px; font-weight: bold; display: flex; justify-content: space-between;">
                <span>Assistent Virtual (IA)</span>
                <span onclick="toggleChat()" style="cursor: pointer;">&times;</span>
            </div>
            <div id="chatMessages" style="flex-grow: 1; padding: 15px; overflow-y: auto; background: #f9f9f9; font-size: 0.9rem;">
                <div style="background: #e0e0e0; padding: 8px 12px; border-radius: 15px 15px 15px 0; margin-bottom: 10px; max-width: 80%; color: #333;">
                    Hola! S√≥c l'Ada, la teva assistent. En qu√® et puc ajudar?
                </div>
            </div>
            <div style="padding: 10px; border-top: 1px solid #eee; display: flex;">
                <input type="text" id="chatInput" placeholder="Escriu..." style="flex-grow: 1; border: 1px solid #ddd; padding: 8px; border-radius: 4px; outline: none;" onkeypress="handleChat(event)">
                <button onclick="sendMessage()" style="background: #D4AF37; color: #fff; border: none; padding: 0 10px; margin-left: 5px; border-radius: 4px; cursor: pointer;">></button>
            </div>
        </div>
    </div>

    <script type="module">
        import { db, ref, get, child, update, onValue } from './firebase.js';

        let userId = localStorage.getItem('currentUserEmail');
        if (!userId) {
            window.location.href = 'login.html';
        }

        let currentActiveOrderKey = null;
        let currentActiveOrderData = null; 
        let allMyOrders = {}; 
        let totalCart = 0; 
        let currentRating = 0;

        // 1. CARREGAR INFO USUARI
        get(child(ref(db), `users/${userId}`)).then((snapshot) => {
            if (snapshot.exists()) {
                const user = snapshot.val();
                document.getElementById('welcomeTitle').innerText = `Hola, ${user.nom}!`;
                document.querySelector('.avatar-mini').innerText = (user.nom.charAt(0) + (user.cognoms ? user.cognoms.charAt(0) : "")).toUpperCase();
            }
        });

        // 2. LISTENER PRINCIPAL
        onValue(ref(db, `users/${userId}/comandes`), (snapshot) => {
            const comandes = snapshot.val();
            allMyOrders = comandes || {}; 
            
            const historyList = document.getElementById('historyList');
            if(historyList) historyList.innerHTML = ''; 
            
            hideAllStates();
            let hasActiveOrder = false;
            
            const estatsActius = ['pendent_preparacio', 'enviada', 'rebuda_simulada'];

            if (comandes) {
                const ordersArray = Object.entries(comandes).sort((a, b) => b[0] - a[0]);

                ordersArray.forEach(([key, order]) => {
                    if (!hasActiveOrder && estatsActius.includes(order.estat)) {
                        hasActiveOrder = true;
                        currentActiveOrderKey = key;
                        currentActiveOrderData = order; 
                        
                        checkNotification(order.estat);
                        renderActiveState(order);
                    } else {
                        renderHistoryItem(order, key);
                    }
                });
            }

            if (!hasActiveOrder) {
                document.getElementById('stateRequest').style.display = 'block';
                document.getElementById('heroCard').style.borderTopColor = "#D4AF37";
            }
        });

        // --- GESTI√ì D'ESTATS ---
        function renderActiveState(order) {
            const hero = document.getElementById('heroCard');
            const status = order.estat;
            hideAllStates();

            if (status === 'pendent_preparacio') {
                document.getElementById('statePending').style.display = 'block';
                hero.style.borderTopColor = "#ccc";
            } 
            else if (status === 'enviada') {
                document.getElementById('stateShipping').style.display = 'block';
                hero.style.borderTopColor = "#D4AF37";
                startTimer(); 
            } 
            else if (status === 'rebuda_simulada') {
                renderReviewScreen(order);
            }
        }

        function hideAllStates() {
            ['stateRequest', 'statePending', 'stateShipping', 'stateReview'].forEach(id => {
                const el = document.getElementById(id);
                if(el) el.style.display = 'none';
            });
        }

        function startTimer() {
            let timeLeft = 15;
            const timerEl = document.getElementById('timer');
            if (window.shippingInterval) clearInterval(window.shippingInterval);
            
            window.shippingInterval = setInterval(() => {
                timeLeft--;
                if(timerEl) timerEl.innerText = timeLeft;
                if (timeLeft <= 0) {
                    clearInterval(window.shippingInterval);
                    update(ref(db), { [`/users/${userId}/comandes/${currentActiveOrderKey}/estat`]: 'rebuda_simulada' });
                }
            }, 1000);
        }

        function checkNotification(status) {
            if (status === 'enviada') {
                if (Notification.permission === "granted") {
                    new Notification("La teva caixa est√† en cam√≠! üöö", { body: "Arriba en 15 segons." });
                } else if (Notification.permission !== "denied") Notification.requestPermission();
            }
        }

        // --- REVISI√ì + MATCH + PREU ---
        function renderReviewScreen(order) {
            document.getElementById('stateReview').style.display = 'block';
            document.getElementById('heroCard').style.borderTopColor = "#2f855a";
            
            const container = document.getElementById('reviewItemsGrid');
            container.innerHTML = '';
            totalCart = 0;

            if (order.items) {
                order.items.forEach(item => {
                    const matchScore = Math.floor(Math.random() * (99 - 85 + 1) + 85);
                    const reason = getSmartReason(item);

                    const div = document.createElement('div');
                    div.className = 'review-item';
                    div.innerHTML = `
                        <div style="position:absolute; top:10px; left:10px; z-index:10;">
                            <div class="match-badge">‚òÖ ${matchScore}% MATCH</div>
                        </div>
                        <div class="review-img" style="background-image:url('${item.img}')"></div>
                        <div style="font-weight:bold; font-size:0.9rem;">${item.name}</div>
                        <div style="color:#666; font-size:0.8rem;">${item.price}‚Ç¨</div>
                        <div class="compatibility-bar"><div class="compatibility-fill" style="width: ${matchScore}%"></div></div>
                        <div class="match-reason">"${reason}"</div>
                        <button class="toggle-btn" onclick="toggleItem(this, ${item.price})" data-kept="false"></button>
                    `;
                    container.appendChild(div);
                });
            }
            updateReviewTotal(0); 
        }

        function getSmartReason(item) {
            const reasons = ["Combina amb el teu estil.", "Teixit pr√®mium.", "Color ideal per tu.", "Tend√®ncia top.", "B√†sic imprescindible."];
            if(item.category === 'shoes') return "Comoditat m√†xima.";
            if(item.category === 'acc') return "Detall clau.";
            return reasons[Math.floor(Math.random() * reasons.length)];
        }

        // --- ACCIONS USUARI GLOBALS ---
        window.processOrder = function() {
            if(confirm("Confirmes el pagament de 10‚Ç¨?")) {
                const newOrder = {
                    data: new Date().toISOString(),
                    estat: "pendent_preparacio",
                    pagamentInicial: 10
                };
                const orderKey = Date.now(); 
                update(ref(db), { [`/users/${userId}/comandes/${orderKey}`]: newOrder });
            }
        }

        window.toggleItem = function(btn, price) {
            const isKept = btn.getAttribute('data-kept') === 'true';
            if (isKept) {
                btn.setAttribute('data-kept', 'false'); btn.classList.remove('keep'); updateReviewTotal(-price);
            } else {
                btn.setAttribute('data-kept', 'true'); btn.classList.add('keep'); updateReviewTotal(price);
            }
        }

        function updateReviewTotal(diff) {
            totalCart += diff;
            const keptCount = document.querySelectorAll('.toggle-btn.keep').length;
            let html = "";
            let finalPay = 0;

            if (keptCount === 0) {
                html = `<div class="price-row">Subtotal Roba: 0.00‚Ç¨</div><div class="alert-text">‚ö†Ô∏è No recuperes els 10‚Ç¨ de servei si no et quedes res.</div><div class="price-final">TOTAL: 0.00‚Ç¨</div>`;
            } else if (keptCount === 5) {
                const discount = totalCart * 0.25;
                finalPay = totalCart - discount - 10;
                html = `<div class="price-row">Subtotal Roba: ${totalCart.toFixed(2)}‚Ç¨</div><div class="price-row discount-text">üéâ FULL BOX (25% Dte): -${discount.toFixed(2)}‚Ç¨</div><div class="price-row discount-text">Devoluci√≥ Service Fee: -10.00‚Ç¨</div><div class="price-final">TOTAL A PAGAR: ${finalPay.toFixed(2)}‚Ç¨</div>`;
            } else {
                finalPay = Math.max(0, totalCart - 10);
                html = `<div class="price-row">Subtotal Roba: ${totalCart.toFixed(2)}‚Ç¨</div><div class="price-row discount-text">Devoluci√≥ Service Fee: -10.00‚Ç¨</div><div class="alert-text">üí° Queda't ${5 - keptCount} peces m√©s per un 25% extra!</div><div class="price-final">TOTAL A PAGAR: ${finalPay.toFixed(2)}‚Ç¨</div>`;
            }
            const totalEl = document.getElementById('reviewTotalArea');
            if(totalEl) totalEl.innerHTML = html;
        }

        // --- FINALITZAR I MOSTRAR TIQUET ---
        window.finalizeReview = function() {
            if (!currentActiveOrderKey || !currentActiveOrderData) {
                alert("Error de sincronitzaci√≥. Recarrega."); return;
            }

            if(confirm("Segur que vols finalitzar? Es procedir√† al cobrament.")) {
                try {
                    const updatedItems = [];
                    const reviewItems = document.querySelectorAll('.review-item');
                    const originalItems = currentActiveOrderData.items || [];
                    
                    let keptItemsList = [];
                    let totalKeptValue = 0;

                    reviewItems.forEach((div, index) => {
                        const btn = div.querySelector('.toggle-btn');
                        const isKept = btn.getAttribute('data-kept') === 'true';
                        if (originalItems[index]) {
                            const itemWithStatus = { ...originalItems[index], kept: isKept };
                            updatedItems.push(itemWithStatus);
                            if(isKept) { keptItemsList.push(itemWithStatus); totalKeptValue += itemWithStatus.price; }
                        }
                    });

                    let finalPay = 0;
                    let discountType = 'none';
                    if (keptItemsList.length === 5) {
                        finalPay = totalKeptValue - (totalKeptValue * 0.25) - 10;
                        discountType = 'fullbox';
                    } else if (keptItemsList.length > 0) {
                        finalPay = Math.max(0, totalKeptValue - 10);
                        discountType = 'basic';
                    }

                    const updates = {};
                    updates[`/users/${userId}/comandes/${currentActiveOrderKey}/items`] = updatedItems;
                    updates[`/users/${userId}/comandes/${currentActiveOrderKey}/estat`] = 'finalitzada';
                    
                    update(ref(db), updates).then(() => {
                        showFinalReceipt(keptItemsList, totalKeptValue, finalPay, discountType);
                    });
                } catch (err) { console.error(err); alert("Error JS: " + err.message); }
            }
        }

        // --- MOSTRAR TIQUET ---
        function showFinalReceipt(keptItems, totalKeptValue, finalPayAmount, discountType) {
            const modal = document.getElementById('receiptModal');
            document.getElementById('receiptDate').innerText = new Date().toLocaleDateString();
            const bodyEl = document.getElementById('receiptBody');
            
            let html = "";
            if (keptItems.length === 0) { html += `<div>No t'has quedat cap pe√ßa.</div>`; } 
            else { keptItems.forEach(item => { html += `<div class="receipt-row"><span>${item.name}</span><span>${item.price.toFixed(2)}‚Ç¨</span></div>`; }); }

            html += `<div style="margin-top: 15px; border-top: 1px dashed #ddd; padding-top:10px;"></div>`;
            html += `<div class="receipt-row" style="font-weight:bold;"><span>Subtotal:</span><span>${totalKeptValue.toFixed(2)}‚Ç¨</span></div>`;

            if (discountType === 'fullbox') {
                const discountAmount = totalKeptValue * 0.25;
                html += `<div class="receipt-row receipt-discount"><span>Dte. 25% Full Box:</span><span>-${discountAmount.toFixed(2)}‚Ç¨</span></div><div class="receipt-row receipt-discount"><span>Retorn Service Fee:</span><span>-10.00‚Ç¨</span></div>`;
            } else if (discountType === 'basic') {
                html += `<div class="receipt-row receipt-discount"><span>Retorn Service Fee:</span><span>-10.00‚Ç¨</span></div>`;
            }

            html += `<div class="receipt-row total"><span>TOTAL PAGAT:</span><span>${finalPayAmount.toFixed(2)}‚Ç¨</span></div>`;
            bodyEl.innerHTML = html;
            modal.style.display = "block"; 
        }

        // --- TANCAR TIQUET -> OBRIR VALORACI√ì ---
        window.closeReceiptAndFinish = function() {
            document.getElementById('receiptModal').style.display = "none";
            const ratingModal = document.getElementById('ratingModal');
            if(ratingModal) {
                ratingModal.style.display = "block";
                resetStars(); 
            } else { resetUI(); }
        }

        // --- VALORACI√ì ---
        window.rateStar = function(n) {
            currentRating = n;
            const stars = document.querySelectorAll('#starContainer .star-btn');
            stars.forEach((star, index) => {
                if (index < n) { star.classList.add('active'); star.style.color = "#D4AF37"; } 
                else { star.classList.remove('active'); star.style.color = "#ddd"; }
            });
        }

        function resetStars() {
            currentRating = 0;
            const stars = document.querySelectorAll('#starContainer .star-btn');
            if(stars) stars.forEach(star => { star.classList.remove('active'); star.style.color = "#ddd"; });
            const textFeedback = document.getElementById('feedbackText');
            if(textFeedback) textFeedback.value = "";
        }

        window.submitFeedback = function() {
            if (currentRating === 0) { alert("Si us plau, selecciona almenys una estrella."); return; }
            const comment = document.getElementById('feedbackText').value;
            const feedbackData = { rating: currentRating, comment: comment, date: new Date().toISOString(), stylist: "Marta R.", client: userId };
            const newFeedbackKey = Date.now();
            update(ref(db), { [`/valoracions/${newFeedbackKey}`]: feedbackData })
            .then(() => { alert("Gr√†cies pel teu feedback! La Marta ho agrair√†."); resetUI(); });
        }

        window.skipFeedback = function() { resetUI(); }

        // --- REINICIAR UI ---
        function resetUI() {
            document.getElementById('ratingModal').style.display = "none";
            document.getElementById('receiptModal').style.display = "none";
            document.getElementById('stateReview').style.display = 'none';
            document.getElementById('stateRequest').style.display = 'block';
            document.getElementById('heroCard').style.borderTopColor = "#D4AF37";
            currentActiveOrderKey = null; currentActiveOrderData = null;
        }

        // --- MODAL DETALLS HISTORIAL ---
        window.showOrderDetails = function(key) {
            const order = allMyOrders[key];
            if(!order) return;
            const modal = document.getElementById('detailsModal');
            const container = document.getElementById('modalItemsContainer');
            document.getElementById('modalDate').innerText = "Data: " + new Date(order.data).toLocaleDateString();
            container.innerHTML = '';
            document.getElementById('modalEmptyMsg').style.display = "none";
            
            let totalQuedat = 0; let itemsCount = 0;
            if (order.items && order.items.length > 0) {
                order.items.forEach(item => {
                    const isKept = item.kept !== undefined ? item.kept : true; 
                    if (isKept) { totalQuedat += item.price; itemsCount++; }
                    const statusBadge = isKept ? '<span style="background:#2f855a; color:white; padding:2px 5px; font-size:0.6rem; border-radius:3px;">QUEDAT</span>' : '<span style="background:#e53e3e; color:white; padding:2px 5px; font-size:0.6rem; border-radius:3px;">RETORNAT</span>';
                    const opacity = isKept ? '1' : '0.5';
                    container.innerHTML += `<div class="modal-item-card" style="opacity:${opacity}"><div class="modal-item-img" style="background-image:url('${item.img}')"></div>${statusBadge}<div style="font-size:0.8rem; font-weight:bold; margin-top:5px;">${item.name}</div><div style="font-size:0.8rem; color:#666;">${item.price}‚Ç¨</div></div>`;
                });
                
                let totalPagar = 0; let textExtra = "";
                if (itemsCount === 5) {
                    const discount = totalQuedat * 0.25;
                    totalPagar = totalQuedat - discount - 10;
                    textExtra = "<br><span style='color:#2f855a; font-size:0.8rem;'>(Inclou Dte. 25% Full Box -10‚Ç¨ Fee)</span>";
                } else if (itemsCount > 0) {
                    totalPagar = Math.max(0, totalQuedat - 10);
                    textExtra = "<br><span style='color:#2f855a; font-size:0.8rem;'>(-10‚Ç¨ pagament inicial)</span>";
                }
                container.innerHTML += `<div style="grid-column:1/-1; margin-top:15px; text-align:right; padding-top:10px; border-top:1px solid #eee;"><div>Valor roba: <strong>${totalQuedat}‚Ç¨</strong></div><div style="font-size:1.1rem; color:#000;">Total Pagat: <strong>${totalPagar.toFixed(2)}‚Ç¨</strong></div>${textExtra}</div>`;
            } else { document.getElementById('modalEmptyMsg').style.display = "block"; }
            modal.style.display = "block";
        }
        window.closeModal = function() { document.getElementById('detailsModal').style.display = "none"; }
        window.onclick = function(event) { if (event.target == document.getElementById('detailsModal')) closeModal(); }

        // --- RENDER HISTORIAL ---
        function renderHistoryItem(order, key) {
            const date = new Date(order.data).toLocaleDateString();
            const li = document.createElement('li');
            li.className = 'history-item done';
            let estatText = order.estat === 'finalitzada' ? 'Completada' : order.estat;
            li.innerHTML = `<div><div style="font-weight:bold;">Caixa del ${date}</div><div style="font-size:0.8rem; color:#666;">Estat: ${estatText}</div></div><div class="details-link" onclick="showOrderDetails('${key}')">Veure detalls</div>`;
            document.getElementById('historyList').appendChild(li);
        }

        const logoutLink = document.querySelector('a[href="index.html"]');
        if(logoutLink) logoutLink.addEventListener('click', () => localStorage.removeItem('currentUserEmail'));

        // --- CHATBOT AMB IA (GPT-3.5) ---
        
        // Clau API dividida per seguretat
        const Part_A = 'sk-proj-tD9Bpt1o9OgsmXxh_-QRdPtP22qBeV6aw8KopFS6OyfYAPmx6KKs3KewZW-Vm5gPgpOAYMY7STT3BlbkFJJT4L_';
        const Part_B = 'wVDg20wo0TV0ArDH-cdsV1ssmS46gBam8wbi0DvmQ_9mVKNiCQhDKCADY4infx_pmDxIA';
        const API_KEY = Part_A + Part_B;

        const SYSTEM_PROMPT = `
            Ets l'Ada, una experta estilista personal de l'empresa "My Personal Shopper".
            El teu to √©s professional, proper, elegant i expert en moda.
            Parles sempre en Catal√†.
            
            Dades de l'empresa:
            - El servei costa 10‚Ç¨, per√≤ es descompta si el client es queda roba.
            - Si es queden les 5 peces (Full Box), tenen un 25% de descompte.
            - Enviament en 24-48h.
            - Devolucions gratu√Øtes amb recollida a domicili.
            
            La teva feina √©s aconsellar sobre estils, resoldre dubtes i animar a comprar.
            Sigues breu i concisa (m√†xim 2 o 3 frases).
        `;

        window.toggleChat = function() { 
            const w = document.getElementById('chatWindow'); 
            w.style.display = w.style.display === 'none' ? 'flex' : 'none'; 
        }
        
        window.handleChat = function(e) { if (e.key === 'Enter') sendMessage(); }
        
        window.sendMessage = async function() {
            const input = document.getElementById('chatInput');
            const text = input.value.trim();
            if (!text) return;

            // 1. Mostrar missatge usuari
            addMessage(text, 'user');
            input.value = '';

            // 2. Mostrar c√†rrega "..."
            const loadingDiv = addMessage('...', 'bot');

            try {
                // 3. Connectar a OpenAI
                const response = await fetch("https://api.openai.com/v1/chat/completions", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${API_KEY}`
                    },
                    body: JSON.stringify({
                        model: "gpt-3.5-turbo",
                        messages: [
                            { role: "system", content: SYSTEM_PROMPT },
                            { role: "user", content: text }
                        ],
                        max_tokens: 150,
                        temperature: 0.7
                    })
                });

                const data = await response.json();
                
                // Eliminem el missatge de "..."
                if(loadingDiv) loadingDiv.remove();

                if (data.error) {
                    addMessage("Ho sento, he tingut un error t√®cnic.", 'bot');
                } else {
                    const reply = data.choices[0].message.content;
                    addMessage(reply, 'bot');
                }
            } catch (error) {
                if(loadingDiv) loadingDiv.remove();
                addMessage("Error de connexi√≥.", 'bot');
            }
        }
        
        function addMessage(text, sender) {
            const div = document.createElement('div');
            div.style.padding = "8px 12px"; 
            div.style.marginBottom = "10px"; 
            div.style.maxWidth = "80%"; 
            div.style.fontSize = "0.9rem";
            
            if (sender === 'user') { 
                div.style.background = "#D4AF37"; 
                div.style.color = "#fff"; 
                div.style.borderRadius = "15px 15px 0 15px"; 
                div.style.marginLeft = "auto"; 
            } else { 
                div.style.background = "#e0e0e0"; 
                div.style.color = "#333"; 
                div.style.borderRadius = "15px 15px 15px 0"; 
            }
            
            div.innerText = text;
            const c = document.getElementById('chatMessages'); 
            c.appendChild(div); 
            c.scrollTop = c.scrollHeight;
            return div; // Retornem l'element per si el volem esborrar (loading)
        }
    </script>
</body>
</html>